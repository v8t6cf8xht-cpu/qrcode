<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>åº«å­˜ QRCode æƒæ</title>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; margin:20px; }
button { padding:8px 12px; margin:4px; }
input, textarea { width:220px; padding:6px; }
#video { width:320px; border:1px solid #ccc; display:none; }

.loc-btn { border:1px solid #999; background:#eee; }
.loc-btn.active { background:#2ecc71; color:#fff; }

.note-btn { color:#fff; border:none; }
.red{background:#e74c3c;}
.orange{background:#e67e22;}
.blue{background:#3498db;}
.gray{background:#95a5a6;color:#000;}

table{border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:6px;text-align:center;}
</style>
</head>
<body>

<h2>ğŸ“¦ åº«å­˜æƒæç³»çµ±</h2>

document.getElementById("startCamBtn").onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });

    video.srcObject = stream;

    // â­ é—œéµï¼ˆiPhone å¿…è¦ï¼‰
    video.setAttribute("playsinline", true);
    video.muted = true;

    await video.play();   // â­ ä¸€å®šè¦å‘¼å«

    video.style.display = "block";
    scanning = true;
    status.textContent = "ç›¸æ©Ÿå·²å•Ÿå‹•ï¼Œè«‹æƒ QRCode";

    requestAnimationFrame(scanLoop);

  } catch (err) {
    status.textContent = "âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—";
    alert("ç›¸æ©ŸéŒ¯èª¤ï¼š" + err.message);
  }
};

<p id="camStatus">ç›¸æ©Ÿå°šæœªå•Ÿå‹•</p>
<video id="video" playsinline></video>

<label>æ–™è™Ÿ</label>
<input id="item" readonly>

<label>å‹è™Ÿ</label>
<input id="model" readonly>

<label>å„²ä½</label><br>
<button class="loc-btn" data-loc="C10-1">C10-1</button>
<button class="loc-btn" data-loc="C10-2">C10-2</button>
<button class="loc-btn" data-loc="C10-5">C10-5</button>

<label>æ•¸é‡</label>
<input id="qty" type="number" value="1" inputmode="numeric">

<label>å‚™è¨»</label><br>
<button class="note-btn red" data-note="ä¸è‰¯å“">ä¸è‰¯å“</button>
<button class="note-btn orange" data-note="å¾…ä¿®å“">å¾…ä¿®å“</button>
<button class="note-btn blue" data-note="å¾…æ­¸ä½">å¾…æ­¸ä½</button>
<button class="note-btn gray" data-note="å…¶ä»–">å…¶ä»–</button>
<br>
<textarea id="note"></textarea>

<br><br>
<button id="saveBtn">å„²å­˜</button>
<button id="nextBtn" disabled>ä¸‹ä¸€å€‹</button>
<button id="exportBtn">åŒ¯å‡º Excel</button>

<table id="recordTable">
<tr>
<th>æ™‚é–“</th><th>æ–™è™Ÿ</th><th>å‹è™Ÿ</th>
<th>å„²ä½</th><th>æ•¸é‡</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
</tr>
</table>

<script>
/* ========= è¨­å®š ========= */
const STORAGE_KEY = "inventory_records";
const itemModelMap = {
  "ABC-123":"ä¼ºæœå™¨é›»æºæ¨¡çµ„",
  "XYZ-888":"æ§åˆ¶æ¿"
};

/* ========= LocalStorage ========= */
let records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
const table = document.getElementById("recordTable");
records.forEach(addRow);

/* ========= å„²ä½ ========= */
let selectedLoc="";
document.querySelectorAll(".loc-btn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".loc-btn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    selectedLoc=b.dataset.loc;
  };
});

/* ========= å‚™è¨» ========= */
document.querySelectorAll(".note-btn").forEach(b=>{
  b.onclick=()=>{
    if(b.dataset.note!=="å…¶ä»–") note.value=b.dataset.note;
    else note.focus();
  };
});

/* ========= ç›¸æ©Ÿ ========= */
const video=document.getElementById("video");
const status=document.getElementById("camStatus");
const canvas=document.createElement("canvas");
const ctx=canvas.getContext("2d");
let scanning=false;

document.getElementById("startCamBtn").onclick = async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"}
    });
    video.srcObject=stream;
    video.style.display="block";
    scanning=true;
    status.textContent="ç›¸æ©Ÿå·²å•Ÿå‹•ï¼Œè«‹æƒ QRCode";
    requestAnimationFrame(scanLoop);
  }catch(e){
    status.textContent="âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™";
    alert("ç›¸æ©Ÿç„¡æ³•å•Ÿå‹•ï¼š" + e.message);
  }
};

function scanLoop(){
  if(!scanning) return;
   if (video.paused || video.ended) return;
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0);
    const img=ctx.getImageData(0,0,canvas.width,canvas.height);
    const code=jsQR(img.data,img.width,img.height);
    if(code){
      scanning=false;
      item.value=code.data;
      model.value=itemModelMap[code.data]||"ï¼ˆæœªè¨­å®šï¼‰";
      nextBtn.disabled=false;
      status.textContent="å·²æƒæï¼Œè«‹è¼¸å…¥è³‡æ–™";
      return;
    }
  }
  requestAnimationFrame(scanLoop);
}

/* ========= å„²å­˜ ========= */
saveBtn.onclick=()=>{
  if(!item.value||!selectedLoc){
    alert("æ–™è™Ÿæˆ–å„²ä½æœªé¸");
    return;
  }
  const d={
    time:new Date().toLocaleString(),
    item:item.value,
    model:model.value,
    loc:selectedLoc,
    qty:qty.value,
    note:note.value
  };
  records.push(d);
  localStorage.setItem(STORAGE_KEY,JSON.stringify(records));
  addRow(d);
};

function addRow(d){
  const r=table.insertRow();
  r.innerHTML=`
    <td>${d.time}</td><td>${d.item}</td><td>${d.model}</td>
    <td>${d.loc}</td><td>${d.qty}</td><td>${d.note}</td>
    <td><button onclick="delRow(this)">åˆªé™¤</button></td>`;
}

function delRow(btn){
  const i=btn.parentNode.parentNode.rowIndex-1;
  records.splice(i,1);
  localStorage.setItem(STORAGE_KEY,JSON.stringify(records));
  table.deleteRow(i+1);
}

/* ========= ä¸‹ä¸€å€‹ ========= */
nextBtn.onclick=()=>{
  item.value=model.value=note.value="";
  qty.value=1;
  selectedLoc="";
  document.querySelectorAll(".loc-btn").forEach(b=>b.classList.remove("active"));
  scanning=true;
  nextBtn.disabled=true;
  status.textContent="è«‹æƒä¸‹ä¸€å€‹ QRCode";
  requestAnimationFrame(scanLoop);
};

/* ========= åŒ¯å‡º ========= */
exportBtn.onclick=()=>{
  const wb=XLSX.utils.table_to_book(table,{sheet:"åº«å­˜"});
  XLSX.writeFile(wb,"åº«å­˜ç´€éŒ„.xlsx");
};
</script>
</body>
</html>


